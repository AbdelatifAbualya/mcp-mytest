

<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enhanced Chain of Draft Studio - DeepSeek V3-0324 with Advanced Reflection</title>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Marked.js for Markdown parsing -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <!-- Highlight.js for code highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  
  <!-- Configuration for Tailwind -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#eef2ff',
              100: '#e0e7ff',
              200: '#c7d2fe',
              300: '#a5b4fc',
              400: '#818cf8',
              500: '#5686f5',
              600: '#4f46e5',
              700: '#4338ca',
              800: '#3730a3',
              900: '#312e81',
              950: '#1e1b4b',
            },
            dark: {
              100: '#d1d5db',
              200: '#9ca3af',
              300: '#6b7280',
              400: '#4b5563',
              500: '#374151',
              600: '#1f2937',
              700: '#111827',
              800: '#0d1117',
              900: '#030712',
            },
            deepseek: {
              100: '#f0f9ff',
              200: '#e0f2fe',
              300: '#7dd3fc',
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e',
            }
          },
          fontFamily: {
            sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'],
            mono: ['JetBrains Mono', 'ui-monospace', 'monospace'],
          },
        }
      }
    };
  </script>

  <style>
    /* Base Styles */
    :root {
      --primary: #5686f5;
      --primary-hover: #4169e1;
      --deepseek: #0ea5e9;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
    }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgb(20, 24, 33);
      border-radius: 8px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(14, 165, 233, 0.6);
      border-radius: 8px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(14, 165, 233, 0.8);
    }

    /* Enhanced CoD Steps Animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    .cod-steps {
      animation: fadeIn 0.4s ease;
    }
    
    .cod-step {
      animation: slideInLeft 0.3s ease;
    }
    
    .reflection-block {
      animation: slideInRight 0.5s ease;
    }
    
    .verification-block {
      animation: fadeIn 0.6s ease;
    }
    
    /* Stage indicator with enhanced animation */
    @keyframes pulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.7); }
      70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(14, 165, 233, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(14, 165, 233, 0); }
    }
    
    .stage-indicator {
      animation: pulse 2s infinite;
    }
    
    /* Streaming Indicator Animation */
    @keyframes typingAnimation {
      0% { border-right-color: rgba(14, 165, 233, 0.7); }
      100% { border-right-color: transparent; }
    }
    
    .streaming {
      border-right: 3px solid rgba(14, 165, 233, 0.7);
      animation: typingAnimation 0.8s infinite ease;
    }
    
    @keyframes ellipsisAnimation {
      0% { content: "."; }
      33% { content: ".."; }
      66% { content: "..."; }
      100% { content: "."; }
    }
    
    .streaming-indicator::after {
      content: "...";
      animation: ellipsisAnimation 1.5s infinite;
    }

    /* Progress Bar with DeepSeek colors */
    .progress-bar {
      background: linear-gradient(90deg, #0ea5e9 0%, #0284c7 100%);
      transition: width 0.3s ease;
    }

    /* Enhanced Range Slider Styling */
    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 4px;
      background: #1f2937;
      border-radius: 4px;
      outline: none;
      background: linear-gradient(to right, var(--deepseek) var(--value-percent, 50%), #1f2937 var(--value-percent, 50%)) !important;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: white !important;
      border-radius: 50%;
      cursor: pointer;
      border: 1px solid rgba(0, 0, 0, 0.1) !important;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      margin-top: -6px;
    }

    /* DeepSeek branding elements */
    .deepseek-gradient {
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 50%, #075985 100%);
    }

    .deepseek-glow {
      box-shadow: 0 0 20px rgba(14, 165, 233, 0.3);
    }

    /* Enhanced reflection indicators */
    .reflection-indicator {
      position: relative;
      overflow: hidden;
    }

    .reflection-indicator::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(14, 165, 233, 0.3), transparent);
      animation: shine 2s infinite;
    }

    @keyframes shine {
      0% { left: -100%; }
      100% { left: 100%; }
    }
  </style>
</head>
<body class="bg-dark-800 text-gray-100 font-sans min-h-screen overflow-hidden">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <div class="w-80 bg-gradient-to-b from-dark-700 to-dark-800 border-r border-dark-600 flex flex-col overflow-y-auto hidden md:flex shadow-2xl">
      <!-- Header -->
      <div class="p-6 border-b border-dark-600/50">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 deepseek-gradient rounded-lg flex items-center justify-center deepseek-glow">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
          </div>
          <div>
            <h2 class="text-lg font-bold text-white">Enhanced CoD Studio</h2>
            <p class="text-xs text-deepseek-300">DeepSeek V3-0324 + Advanced Reflection</p>
          </div>
        </div>
        
        <!-- New Session Button -->
        <button id="newThreadBtn" class="w-full deepseek-gradient hover:from-deepseek-600 hover:to-deepseek-700 text-white py-3 px-4 rounded-xl transition-all duration-200 flex items-center justify-center gap-3 shadow-lg hover:shadow-xl transform hover:scale-105 deepseek-glow">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          <span class="font-medium">New Research Session</span>
        </button>
      </div>

      <!-- System Status -->
      <div class="p-4 border-b border-dark-600/50">
        <!-- DeepSeek Status -->
        <div class="bg-gradient-to-r from-deepseek-900/20 to-blue-900/20 border border-deepseek-500/30 rounded-lg p-3 mb-3">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <div class="w-2 h-2 bg-deepseek-400 rounded-full animate-pulse"></div>
              <span class="text-deepseek-300 text-sm font-medium">DeepSeek V3-0324</span>
            </div>
            <span id="modelStatus" class="text-deepseek-400 text-xs bg-deepseek-900/30 px-2 py-1 rounded-full">Active</span>
          </div>
          <div class="text-deepseek-200 text-xs">Latest reasoning model with reflection</div>
        </div>
        
        <!-- Memory Status -->
        <div class="bg-gradient-to-r from-green-900/20 to-emerald-900/20 border border-green-500/30 rounded-lg p-3">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <span class="text-green-300 text-sm font-medium">Memory Active</span>
            </div>
            <span id="memoryCount" class="text-green-400 text-xs bg-green-900/30 px-2 py-1 rounded-full">0 items</span>
          </div>
          <div class="text-green-200 text-xs">Storing conversations & preferences</div>
        </div>
      </div>

      <!-- Threads Section -->
      <div class="flex-1 p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-medium text-gray-300 uppercase tracking-wider">Recent Sessions</h3>
          <span id="threadCount" class="text-xs bg-dark-600 text-gray-400 px-2 py-1 rounded-full">1</span>
        </div>
        <ul id="threadList" class="space-y-2 mb-6">
          <li class="bg-dark-600/50 hover:bg-dark-600 text-deepseek-300 px-4 py-3 rounded-xl cursor-pointer transition-all duration-200 border border-dark-500/50 hover:border-deepseek-500/50">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 bg-deepseek-500/20 rounded-lg flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-deepseek-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
              </div>
              <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-white truncate">Research Session 1</p>
                <p class="text-xs text-gray-400">Just now</p>
              </div>
            </div>
          </li>
        </ul>
      </div>

      <!-- Export & Actions Section -->
      <div class="p-4 border-t border-dark-600/50 space-y-3">
        <div class="text-xs font-medium text-gray-400 uppercase tracking-wider mb-3 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3M3 17V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path>
          </svg>
          Export Research
        </div>
        
        <!-- Export Buttons -->
        <div class="grid grid-cols-2 gap-2 mb-4">
          <button id="downloadTxtBtn" class="bg-dark-600 hover:bg-dark-500 text-gray-300 hover:text-white py-3 px-3 rounded-lg transition-all duration-200 flex flex-col items-center gap-1 border border-dark-500 hover:border-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <span class="text-xs font-medium">TXT</span>
          </button>
          <button id="downloadPdfBtn" class="bg-dark-600 hover:bg-dark-500 text-gray-300 hover:text-white py-3 px-3 rounded-lg transition-all duration-200 flex flex-col items-center gap-1 border border-dark-500 hover:border-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
            </svg>
            <span class="text-xs font-medium">PDF</span>
          </button>
        </div>

        <!-- Quick Actions -->
        <div class="text-xs font-medium text-gray-400 uppercase tracking-wider mb-2 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
          </svg>
          Quick Actions
        </div>
        
        <div class="space-y-2">
          <button id="clearThreadBtn" class="w-full bg-dark-600 hover:bg-dark-500 text-gray-300 hover:text-white py-2.5 px-4 rounded-lg transition-all duration-200 flex items-center gap-3 border border-dark-500 hover:border-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
            <span class="text-sm">Clear Session</span>
          </button>
          
          <button id="deleteThreadBtn" class="w-full bg-red-600/20 hover:bg-red-600/30 text-red-400 hover:text-red-300 py-2.5 px-4 rounded-lg transition-all duration-200 flex items-center gap-3 border border-red-600/20 hover:border-red-500/50">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
            <span class="text-sm">Delete Session</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Mobile Sidebar Toggle -->
    <div id="mobileSidebarToggle" class="fixed left-4 top-4 bg-dark-700 p-2 rounded-md shadow-lg z-20 md:hidden">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
      </svg>
    </div>

    <!-- Mobile Sidebar -->
    <div id="mobileSidebar" class="fixed inset-0 bg-dark-800 z-30 transform -translate-x-full transition-transform duration-300 md:hidden">
      <div class="w-full h-full flex flex-col">
        <div class="flex justify-between items-center p-4 border-b border-dark-600">
          <h2 class="text-xl font-semibold">Sessions</h2>
          <button id="closeMobileSidebar" class="p-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div class="flex-1 p-4 overflow-y-auto">
          <ul id="mobileThreadList" class="space-y-2 mb-4">
            <li class="bg-dark-600 text-deepseek-300 px-3 py-2 rounded-md cursor-pointer hover:bg-dark-500 transition">Research Session 1</li>
          </ul>
          <div class="space-y-2">
            <button id="mobileNewThreadBtn" class="w-full deepseek-gradient hover:from-deepseek-600 hover:to-deepseek-700 text-white py-2 px-4 rounded-md transition flex items-center justify-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              </svg>
              New Session
            </button>
            <button id="mobileDeleteThreadBtn" class="w-full bg-dark-600 hover:bg-dark-500 text-gray-300 py-2 px-4 rounded-md transition">Delete Session</button>
            <button id="mobileDownloadTxtBtn" class="w-full bg-dark-600 hover:bg-dark-500 text-gray-300 py-2 px-4 rounded-md transition">Download TXT</button>
            <button id="mobileClearThreadBtn" class="w-full bg-red-600/20 hover:bg-red-600/30 text-red-400 py-2 px-4 rounded-md transition">Clear Session</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <!-- Header -->
      <header class="bg-dark-700 border-b border-dark-600 h-16 flex items-center justify-between px-4 md:px-6">
        <h1 id="pageTitle" class="text-xl font-semibold">Enhanced CoD Studio - DeepSeek V3-0324</h1>
        <div class="flex items-center gap-3">
          <div id="currentModelDisplay" class="bg-dark-600 text-sm px-3 py-1.5 rounded-lg flex items-center gap-2">
            <div class="w-2 h-2 bg-deepseek-400 rounded-full animate-pulse"></div>
            <span id="modelDisplayText">DeepSeek V3-0324</span>
            <span id="adaptiveIndicator" class="hidden bg-purple-500/20 text-purple-300 text-xs px-2 py-1 rounded-full">🧠 Adaptive</span>
          </div>
          <button id="openSettings" class="flex items-center gap-1.5 bg-dark-600 hover:bg-dark-500 text-gray-300 px-3 py-1.5 rounded-lg transition">
            <span>Settings</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
          </button>
        </div>
      </header>

      <!-- Progress Bar -->
      <div id="progressContainer" class="bg-dark-600 h-2 overflow-hidden hidden">
        <div id="progressBar" class="progress-bar h-full w-0"></div>
      </div>

      <!-- Chat Messages Area -->
      <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-6"></div>

      <!-- Input Area -->
      <div class="p-4 border-t border-dark-600 bg-dark-700">
        <!-- Image Preview Area -->
        <div id="imagePreviewArea" class="mb-4 hidden">
          <div class="text-xs font-medium text-gray-400 uppercase tracking-wider mb-2 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            Attached Images
          </div>
          <div id="imagePreviewContainer" class="flex flex-wrap gap-2 mb-3"></div>
        </div>

        <div class="flex items-start gap-3 rounded-xl bg-dark-600 p-3 shadow-lg border border-dark-500 focus-within:border-deepseek-500 transition">
          <div class="flex-1">
            <textarea id="userInput" rows="1" class="w-full bg-dark-700 text-gray-100 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-deepseek-500 resize-none text-base" placeholder="Ask a complex research question for enhanced CoD reasoning with DeepSeek V3-0324..."></textarea>
          </div>
          <div class="flex flex-col gap-2 mt-1">
            <button id="sendBtn" class="deepseek-gradient hover:from-deepseek-600 hover:to-deepseek-700 text-white p-3 rounded-lg transition deepseek-glow">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path>
              </svg>
            </button>
            <label for="imageInput" class="bg-purple-600 hover:bg-purple-700 text-white p-2.5 rounded-lg cursor-pointer transition" title="Upload Images (Vision Models)">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
            </label>
            <label for="fileInput" class="bg-dark-500 hover:bg-dark-400 text-gray-300 p-2.5 rounded-lg cursor-pointer transition" title="Upload Files">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
              </svg>
            </label>
          </div>
        </div>
        <input type="file" id="imageInput" class="hidden" multiple accept="image/*">
        <input type="file" id="fileInput" class="hidden" multiple>
        <div id="attachedFiles" class="mt-3 flex flex-wrap gap-3 hidden"></div>
      </div>
    </div>
  </div>

  <!-- Status Notification -->
  <div id="statusNotification" class="fixed bottom-4 right-4 bg-dark-600 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50"></div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-dark-700 rounded-xl shadow-2xl max-w-5xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-5 border-b border-dark-600 flex justify-between items-center">
        <h2 class="text-xl font-semibold">Enhanced AI Configuration - DeepSeek V3-0324</h2>
        <button id="closeModalX" class="text-gray-400 hover:text-white">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="p-5">
        <!-- Tab Navigation -->
        <div class="bg-dark-600 rounded-lg p-1 flex mb-5 overflow-x-auto">
          <button class="tab-btn flex-shrink-0 py-2 px-4 rounded-md text-white bg-deepseek-500" data-tab="modelTab">🤖 Model</button>
          <button class="tab-btn flex-shrink-0 py-2 px-4 rounded-md text-gray-400 transition" data-tab="codTab">🧠 CoD Settings</button>
          <button class="tab-btn flex-shrink-0 py-2 px-4 rounded-md text-gray-400 transition" data-tab="parametersTab">⚙️ Parameters</button>
          <button class="tab-btn flex-shrink-0 py-2 px-4 rounded-md text-gray-400 transition" data-tab="reflectionTab">🔄 Reflection</button>
          <button class="tab-btn flex-shrink-0 py-2 px-4 rounded-md text-gray-400 transition" data-tab="memoryTab">💾 Memory</button>
        </div>
        
        <!-- Model Selection Tab -->
        <div id="modelTab" class="tab-content">
          <h3 class="text-lg font-medium mb-4 pb-2 border-b border-dark-600">DeepSeek V3-0324 Configuration</h3>
          
          <!-- DeepSeek Model Info -->
          <div class="mb-6">
            <div class="bg-gradient-to-r from-deepseek-900/20 to-blue-900/20 border border-deepseek-500/30 rounded-lg p-4">
              <div class="flex items-center text-deepseek-300 text-sm font-medium mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                DeepSeek V3-0324 - Latest Reasoning Model
                <span class="bg-deepseek-600/20 text-deepseek-300 text-xs px-2 py-1 rounded-full ml-2">FIREWORKS.AI</span>
              </div>
              <div class="text-deepseek-100 text-xs space-y-1">
                <p>• 671B total parameters with 37B activated per token (MoE architecture)</p>
                <p>• Enhanced reasoning capabilities with R1 distillation</p>
                <p>• Optimized for complex problem-solving and mathematical reasoning</p>
                <p>• Built-in verification and reflection patterns</p>
              </div>
            </div>
          </div>
          
          <!-- Model Path Configuration -->
          <div class="mb-6">
            <h4 class="text-sm font-medium text-gray-300 mb-3">Model Path</h4>
            <div class="bg-dark-600 rounded-lg p-4 border border-dark-500">
              <input type="text" id="modelPath" value="accounts/fireworks/models/deepseek-v3-0324" readonly
                     class="w-full bg-dark-700 text-gray-100 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-deepseek-500 font-mono">
              <div class="text-xs text-gray-400 mt-2">
                Model path for Fireworks.ai API - DeepSeek V3-0324 is the latest version with enhanced reasoning
              </div>
            </div>
          </div>
          
          <!-- Temperature Mapping Info -->
          <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4">
            <div class="flex items-center text-blue-300 text-sm font-medium mb-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              DeepSeek Temperature Mapping
            </div>
            <div class="text-blue-100 text-xs">
              DeepSeek V3-0324 uses temperature mapping: API temp 1.0 → Model temp 0.3 for optimal performance
            </div>
          </div>
        </div>
        
        <!-- CoD Settings Tab -->
        <div id="codTab" class="tab-content hidden">
          <h3 class="text-lg font-medium mb-4 pb-2 border-b border-dark-600">Enhanced Chain of Draft Configuration</h3>
          
          <!-- Reasoning Method Selection -->
          <div class="bg-dark-600 border border-dark-500 rounded-lg p-4 mb-5">
            <h4 class="text-sm font-medium text-gray-300 mb-3">Reasoning Method</h4>
            <div class="space-y-3">
              <div class="flex items-start">
                <input type="radio" id="standardReasoning" name="reasoningMethod" value="standard" class="w-4 h-4 mt-1 text-deepseek-500 bg-dark-500 border-dark-400 focus:ring-deepseek-500 focus:ring-offset-dark-700">
                <label for="standardReasoning" class="ml-3 block text-sm font-medium text-white">
                  Standard (No special reasoning)
                  <div class="text-gray-400 text-xs mt-1">Direct model responses without Chain of Draft methodology.</div>
                </label>
              </div>
              
              <div class="flex items-start">
                <input type="radio" id="enhancedCoD" name="reasoningMethod" value="enhanced_cod" checked class="w-4 h-4 mt-1 text-deepseek-500 bg-dark-500 border-dark-400 focus:ring-deepseek-500 focus:ring-offset-dark-700">
                <label for="enhancedCoD" class="ml-3 block text-sm font-medium text-white">
                  Enhanced Chain of Draft with Dual-Stage Verification
                  <div class="text-gray-400 text-xs mt-1">Advanced CoD with two-stage API calls: Draft + Reflection → Final Verification & Answer</div>
                </label>
              </div>
            </div>
          </div>
          
          <!-- CoD Word Limit Settings -->
          <div id="codWordLimitSection" class="mb-5">
            <h4 class="text-sm font-medium text-gray-300 mb-3">CoD Word Limits (Research-Optimized)</h4>
            <div class="bg-dark-600 border border-dark-500 rounded-lg p-4 space-y-3">
              <div class="flex items-start">
                <input type="radio" id="cod5Words" name="codWordLimit" value="5" checked class="w-4 h-4 mt-1 text-deepseek-500 bg-dark-500 border-dark-400">
                <label for="cod5Words" class="ml-3 block text-sm font-medium text-white">
                  5 words per step
                  <div class="text-gray-400 text-xs mt-1">Original paper recommendation - maximum efficiency (7.6% of CoT tokens)</div>
                </label>
              </div>
              
              <div class="flex items-start">
                <input type="radio" id="cod8Words" name="codWordLimit" value="8" class="w-4 h-4 mt-1 text-deepseek-500 bg-dark-500 border-dark-400">
                <label for="cod8Words" class="ml-3 block text-sm font-medium text-white">
                  8 words per step
                  <div class="text-gray-400 text-xs mt-1">Enhanced clarity while maintaining efficiency - optimal for research</div>
                </label>
              </div>
              
              <div class="flex items-start">
                <input type="radio" id="cod12Words" name="codWordLimit" value="12" class="w-4 h-4 mt-1 text-deepseek-500 bg-dark-500 border-dark-400">
                <label for="cod12Words" class="ml-3 block text-sm font-medium text-white">
                  12 words per step
                  <div class="text-gray-400 text-xs mt-1">Balanced approach for complex scientific reasoning</div>
                </label>
              </div>
              
              <div class="flex items-start">
                <input type="radio" id="cod15Words" name="codWordLimit" value="15" class="w-4 h-4 mt-1 text-deepseek-500 bg-dark-500 border-dark-400">
                <label for="cod15Words" class="ml-3 block text-sm font-medium text-white">
                  15 words per step
                  <div class="text-gray-400 text-xs mt-1">Detailed steps for mathematical and analytical tasks</div>
                </label>
              </div>
            </div>
          </div>
          
          <!-- Adaptive Reasoning Section -->
          <div class="bg-gradient-to-r from-purple-900/20 to-blue-900/20 border border-purple-500/30 rounded-lg p-4 mb-5">
            <h4 class="text-sm font-medium text-purple-300 mb-3 flex items-center gap-2">
              <span>🧠</span>
              Adaptive Reasoning Enhancement
              <span class="bg-purple-600/20 text-purple-300 text-xs px-2 py-1 rounded-full">AI-POWERED</span>
            </h4>
            
            <div class="space-y-3">
              <div class="flex items-start">
                <input type="radio" id="adaptiveComplexity" name="reasoningEnhancement" value="adaptive" class="w-4 h-4 mt-1 text-purple-500 bg-dark-500 border-dark-400">
                <label for="adaptiveComplexity" class="ml-3 block text-sm font-medium text-white">
                  Adaptive Complexity Detection
                  <div class="text-purple-200 text-xs mt-1">Automatically adjusts reasoning depth and word limits based on problem complexity analysis</div>
                </label>
              </div>
              
              <div class="flex items-start">
                <input type="radio" id="fixedReasoning" name="reasoningEnhancement" value="fixed" checked class="w-4 h-4 mt-1 text-purple-500 bg-dark-500 border-dark-400">
                <label for="fixedReasoning" class="ml-3 block text-sm font-medium text-white">
                  Fixed Reasoning Depth
                  <div class="text-purple-200 text-xs mt-1">Uses consistent reasoning approach and word limits for all problems</div>
                </label>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Parameters Tab Content -->
        <div id="parametersTab" class="tab-content hidden">
          <h3 class="text-lg font-medium mb-4 pb-2 border-b border-dark-600">DeepSeek V3-0324 Parameters</h3>
          
          <div class="flex items-center justify-between mb-5 bg-dark-600 rounded-lg p-3 border border-dark-500">
            <label for="streamingToggle" class="flex items-center cursor-pointer">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-deepseek-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
              </svg>
              <div>
                <div class="font-medium text-sm">Enable Streaming Responses</div>
                <div class="text-gray-400 text-xs mt-0.5">See responses appear in real-time as they're generated</div>
              </div>
            </label>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="streamingToggle" class="sr-only peer" checked>
              <div class="w-11 h-6 bg-dark-500 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-deepseek-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-deepseek-600"></div>
            </label>
          </div>
          
          <div class="mb-4">
            <div class="flex justify-between items-center mb-2">
              <label for="temp" class="block text-sm font-medium text-gray-300">Temperature (Auto-mapped for DeepSeek)</label>
              <span id="tempValue" class="text-sm text-gray-400">0.3</span>
            </div>
            <input type="range" id="temp" min="0" max="2" step="0.01" value="0.3" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
            <p class="text-xs text-gray-500 mt-1">DeepSeek automatically maps API temperature for optimal performance</p>
          </div>
          
          <div class="mb-4">
            <div class="flex justify-between items-center mb-2">
              <label for="topP" class="block text-sm font-medium text-gray-300">Top P</label>
              <span id="topPValue" class="text-sm text-gray-400">0.9</span>
            </div>
            <input type="range" id="topP" min="0" max="1" step="0.01" value="0.9" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
            <p class="text-xs text-gray-500 mt-1">Controls diversity via nucleus sampling.</p>
          </div>

          <div class="mb-4">
            <div class="flex justify-between items-center mb-2">
              <label for="topK" class="block text-sm font-medium text-gray-300">Top K</label>
              <span id="topKValue" class="text-sm text-gray-400">40</span>
            </div>
            <input type="range" id="topK" min="0" max="100" step="1" value="40" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
            <p class="text-xs text-gray-500 mt-1">Restricts selection to the K most likely tokens.</p>
          </div>
          
          <div class="mb-4">
            <div class="flex justify-between items-center mb-2">
              <label for="maxTokens" class="block text-sm font-medium text-gray-300">Max Tokens</label>
              <span id="maxTokensValue" class="text-sm text-gray-400">8192</span>
            </div>
            <input type="range" id="maxTokens" min="1" max="16384" step="128" value="8192" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
            <p class="text-xs text-gray-500 mt-1">Maximum length of the response.</p>
          </div>
        </div>
        
        <!-- Reflection Tab -->
        <div id="reflectionTab" class="tab-content hidden">
          <h3 class="text-lg font-medium mb-4 pb-2 border-b border-dark-600">Advanced Reflection & Verification System</h3>
          
          <div class="bg-gradient-to-r from-indigo-900/20 to-purple-900/20 border border-indigo-500/30 rounded-lg p-4 mb-6">
            <div class="flex items-center text-indigo-300 text-sm font-medium mb-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              Two-Stage API System
              <span class="bg-indigo-600/20 text-indigo-300 text-xs px-2 py-1 rounded-full ml-2">ENHANCED</span>
            </div>
            <div class="text-indigo-100 text-xs space-y-1">
              <p><strong>Stage 1:</strong> Analysis → CoD Steps → Initial Reflection → Draft Solution</p>
              <p><strong>Stage 2:</strong> Deep Verification → Error Checking → Final Reflection → Comprehensive Answer</p>
            </div>
          </div>
          
          <!-- Reflection Techniques -->
          <div class="mb-6">
            <h4 class="text-sm font-medium text-gray-300 mb-4">Reflection Techniques</h4>
            
            <div class="space-y-3">
              <label class="flex items-start p-3 bg-dark-600 rounded-lg border border-dark-500 cursor-pointer hover:border-indigo-500/50 transition">
                <input type="checkbox" id="enableSelfVerification" checked class="w-4 h-4 mt-1 text-indigo-500 bg-dark-500 border-dark-400 rounded focus:ring-indigo-500">
                <div class="ml-3">
                  <div class="font-medium text-white">Self-Verification</div>
                  <div class="text-gray-400 text-xs mt-1">Model checks its own reasoning steps for logical consistency</div>
                </div>
              </label>
              
              <label class="flex items-start p-3 bg-dark-600 rounded-lg border border-dark-500 cursor-pointer hover:border-indigo-500/50 transition">
                <input type="checkbox" id="enableErrorDetection" checked class="w-4 h-4 mt-1 text-indigo-500 bg-dark-500 border-dark-400 rounded focus:ring-indigo-500">
                <div class="ml-3">
                  <div class="font-medium text-white">Error Detection & Correction</div>
                  <div class="text-gray-400 text-xs mt-1">Actively searches for and corrects potential errors in reasoning</div>
                </div>
              </label>
              
              <label class="flex items-start p-3 bg-dark-600 rounded-lg border border-dark-500 cursor-pointer hover:border-indigo-500/50 transition">
                <input type="checkbox" id="enableAlternativeSearch" checked class="w-4 h-4 mt-1 text-indigo-500 bg-dark-500 border-dark-400 rounded focus:ring-indigo-500">
                <div class="ml-3">
                  <div class="font-medium text-white">Alternative Approach Search</div>
                  <div class="text-gray-400 text-xs mt-1">Explores alternative solution paths to validate the primary approach</div>
                </div>
              </label>
              
              <label class="flex items-start p-3 bg-dark-600 rounded-lg border border-dark-500 cursor-pointer hover:border-indigo-500/50 transition">
                <input type="checkbox" id="enableConfidenceAssessment" checked class="w-4 h-4 mt-1 text-indigo-500 bg-dark-500 border-dark-400 rounded focus:ring-indigo-500">
                <div class="ml-3">
                  <div class="font-medium text-white">Confidence Assessment</div>
                  <div class="text-gray-400 text-xs mt-1">Evaluates confidence levels and identifies areas of uncertainty</div>
                </div>
              </label>
            </div>
          </div>
          
          <!-- Verification Depth -->
          <div class="mb-6">
            <h4 class="text-sm font-medium text-gray-300 mb-3">Verification Depth</h4>
            <div class="bg-dark-600 rounded-lg p-4">
              <select id="verificationDepth" class="w-full bg-dark-700 text-gray-100 rounded-lg p-3 border border-dark-500 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="basic">Basic - Quick validation of key steps</option>
                <option value="standard" selected>Standard - Comprehensive verification</option>
                <option value="deep">Deep - Exhaustive analysis with multiple approaches</option>
                <option value="research">Research - Academic-level rigor with extensive validation</option>
              </select>
              <div class="text-gray-400 text-xs mt-2">
                Higher verification depth increases accuracy but requires more processing time
              </div>
            </div>
          </div>
        </div>
        
        <!-- Memory Control Tab -->
        <div id="memoryTab" class="tab-content hidden">
          <h3 class="text-lg font-medium mb-4 pb-2 border-b border-dark-600">Memory Control System</h3>
          
          <div class="bg-gradient-to-r from-green-900/20 to-emerald-900/20 border border-green-500/30 rounded-lg p-4 mb-6">
            <div class="flex items-center text-green-300 text-sm font-medium mb-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              Memory System Status
              <span class="bg-green-600/20 text-green-300 text-xs px-2 py-1 rounded-full ml-2">VERCEL KV</span>
            </div>
            <div class="text-green-100 text-xs">
              Powered by Vercel KV (Redis) for persistent, high-performance memory storage. Stores conversations, preferences, and context across sessions.
            </div>
          </div>
          
          <!-- Information Categories -->
          <div class="mb-6">
            <h4 class="text-sm font-medium text-gray-300 mb-3 flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
              </svg>
              Information Categories to Save
            </h4>
            
            <div class="space-y-3">
              <label class="flex items-start p-3 bg-dark-600 rounded-lg border border-dark-500 cursor-pointer hover:border-green-500/50 transition">
                <input type="checkbox" id="savePersonalInfo" checked class="w-4 h-4 mt-1 text-green-500 bg-dark-500 border-dark-400 rounded focus:ring-green-500">
                <div class="ml-3">
                  <div class="font-medium text-white">Personal Information & Research Preferences</div>
                  <div class="text-gray-400 text-xs mt-1">Store user preferences, research style, and personal context</div>
                </div>
              </label>
              
              <label class="flex items-start p-3 bg-dark-600 rounded-lg border border-dark-500 cursor-pointer hover:border-green-500/50 transition">
                <input type="checkbox" id="saveProjectDetails" checked class="w-4 h-4 mt-1 text-green-500 bg-dark-500 border-dark-400 rounded focus:ring-green-500">
                <div class="ml-3">
                  <div class="font-medium text-white">Research Projects & Methodologies</div>
                  <div class="text-gray-400 text-xs mt-1">Remember ongoing research, methodologies, and project-related information</div>
                </div>
              </label>
              
              <label class="flex items-start p-3 bg-dark-600 rounded-lg border border-dark-500 cursor-pointer hover:border-green-500/50 transition">
                <input type="checkbox" id="saveTechnicalKnowledge" checked class="w-4 h-4 mt-1 text-green-500 bg-dark-500 border-dark-400 rounded focus:ring-green-500">
                <div class="ml-3">
                  <div class="font-medium text-white">Technical Knowledge & CoD Patterns</div>
                  <div class="text-gray-400 text-xs mt-1">Store reasoning patterns, technical decisions, and CoD optimization insights</div>
                </div>
              </label>
              
              <label class="flex items-start p-3 bg-dark-600 rounded-lg border border-dark-500 cursor-pointer hover:border-green-500/50 transition">
                <input type="checkbox" id="saveReflectionHistory" checked class="w-4 h-4 mt-1 text-green-500 bg-dark-500 border-dark-400 rounded focus:ring-green-500">
                <div class="ml-3">
                  <div class="font-medium text-white">Reflection & Verification History</div>
                  <div class="text-gray-400 text-xs mt-1">Store successful reflection patterns and verification strategies</div>
                </div>
              </label>
            </div>
          </div>
          
          <!-- Memory Statistics -->
          <div class="bg-dark-600 rounded-lg p-4 border border-dark-500">
            <h5 class="text-sm font-medium text-gray-300 mb-3">Memory Statistics</h5>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
              <div class="bg-dark-700 rounded-lg p-3">
                <div id="memoryPersonalCount" class="text-lg font-bold text-green-400">0</div>
                <div class="text-xs text-gray-400">Personal</div>
              </div>
              <div class="bg-dark-700 rounded-lg p-3">
                <div id="memoryProjectCount" class="text-lg font-bold text-blue-400">0</div>
                <div class="text-xs text-gray-400">Projects</div>
              </div>
              <div class="bg-dark-700 rounded-lg p-3">
                <div id="memoryTechnicalCount" class="text-lg font-bold text-purple-400">0</div>
                <div class="text-xs text-gray-400">Technical</div>
              </div>
              <div class="bg-dark-700 rounded-lg p-3">
                <div id="memoryReflectionCount" class="text-lg font-bold text-indigo-400">0</div>
                <div class="text-xs text-gray-400">Reflections</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="flex justify-end gap-3 pt-4 mt-4 border-t border-dark-600">
          <button id="closeSettings" class="px-4 py-2 bg-dark-600 hover:bg-dark-500 text-gray-300 rounded-lg transition">
            Cancel
          </button>
          <button id="saveSettings" class="px-4 py-2 deepseek-gradient hover:from-deepseek-600 hover:to-deepseek-700 text-white rounded-lg transition">
            Save Settings
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * Enhanced Configuration for DeepSeek V3-0324
     ***********************/
    const CONFIG = {
      // Model Configuration - Fixed to DeepSeek V3-0324
      currentModel: "accounts/fireworks/models/deepseek-v3-0324",
      isVisionModel: false, // DeepSeek V3-0324 doesn't have vision capabilities
      
      // Enhanced Reasoning Configuration
      reasoningMethod: "enhanced_cod", // New enhanced method
      codWordLimit: 5, // Start with research-proven optimal
      reasoningEnhancement: "fixed", // "adaptive" or "fixed"
      
      // Two-Stage API Configuration
      enableTwoStageAPI: true,
      stage1_analysis: true,
      stage2_verification: true,
      
      // Reflection Configuration
      reflectionSettings: {
        enableSelfVerification: true,
        enableErrorDetection: true,
        enableAlternativeSearch: true,
        enableConfidenceAssessment: true,
        verificationDepth: "standard" // basic, standard, deep, research
      },
      
      // Generation Parameters (DeepSeek V3-0324 optimized)
      temperature: 0.3, // DeepSeek's optimal temperature
      topP: 0.9,
      topK: 40,
      maxTokens: 8192,
      enableStreaming: true,
      
      // Memory Configuration
      memoryCategories: {
        personalInfo: true,
        projectDetails: true,
        technicalKnowledge: true,
        reflectionHistory: true
      },
      memoryRetention: "forever"
    };

    // Enhanced Memory Storage
    const MEMORY = {
      personal: [],
      projects: [],
      technical: [],
      reflections: [],
      conversations: []
    };

    /*====================================
     * ENHANCED PROMPTS FOR DEEPSEEK V3-0324
     ===================================*/
    const ENHANCED_PROMPTS = {
      // Stage 1: Analysis + Initial CoD
      stage1_analysis_cod: (wordLimit) => `You are DeepSeek V3-0324, an advanced reasoning model. This is STAGE 1 of a two-stage enhanced reasoning process.

CRITICAL INSTRUCTIONS:
1. First, analyze the problem complexity and structure, make sure to think of every single aspect of that task, you must analysis that is 100% covers of all aspect of how the user prompt will be done the steps, and what are possible issues, and how to solve them.
2. Then apply Chain of Draft (CoD) methodology with EXACTLY ${wordLimit} words per step except if you need to think with more steps and words to get the 100%.
4. End with a draft solution, point the steps and what issues could arrise and how you can sovle them.

FORMAT:
#### PROBLEM ANALYSIS
[Analyze complexity, identify key components, determine approach]

#### CHAIN OF DRAFT STEPS
CoD Step 1: [${wordLimit} words maximum]
CoD Step 2: [${wordLimit} words maximum]
CoD Step 3: [${wordLimit} words maximum]
[Continue as needed...]

#### INITIAL REFLECTION
[Reflect on reasoning quality, identify potential issues, assess confidence, find if any part no matter how small its, any edge cases that the first reasoning missed to acheive 100% of what the user asked, anything the full 100% is a fail, dig deep and think if inything was missed or impmented in the wrong way or any possible case.]

#### DRAFT SOLUTION
[Provide initial solution based on CoD analysis]

Remember: This is STAGE 1. Be thorough but prepare for STAGE 2 verification.`,

      // Stage 2: Deep Verification + Final Answer
      stage2_verification: () => `You are DeepSeek V3-0324 in STAGE 2 of enhanced reasoning. You will now perform deep verification, you must think of the full understandng of question inclding any small edge case that might have been missed, if you are not 100% sure about any point think as long as you wany until yopu make sure that the soluation that was mentioned with achevieve 100%, if not add why then prvide a solution and provide the final comprehensive answer that is perfect, flawless,that takes all what was mentioned into consideration, then write a full code that will fulfill every single part of the user prompt and every signle assue that could happend, the goal if 100% regardless of how many lines it takes, if it takes 1000 line to get from competing 99% of user prompt and it takes 3000 lines to have 100% then anything less than 100% is complete fail.

Your task:
1. CRITICALLY EXAMINE the Stage 1 analysis and CoD steps, your goal is to have an examine that does miss anything, no minor or unliky it's, and if you need to use more than the CD word to make sure you 00% don't miss anything then if takes 1000 line to get from competing 99% of user prompt and it takes 3000 lines to have 100% then anything less than 100% is complete fail.
2. VERIFY each reasoning step for accuracy and logical consistency, could any errors that could arise that it missed, think in depth of any edge cases that they might have missed or implemented in a way that might complacate things in later steps casuing issues, if takes 1000 line to complete 99% of user prompt and 3000 lines to have 100% then anything less than 100% is complete fail.
3. CHECK for mathematical errors, logical fallacies, or incomplete reasoning
4. EXPLORE alternative approaches if needed%
6. PROVIDE a comprehensive final answer, you are not limteed but COD here, your limit is anything less than a a code that is flawless, perfect, takes all what was mentioned in the dssatio then implment them perfect way regardless of how many lines it takes , if your code comepetes 99% and it takes 2000 more lines to compete every single part or subpart of the user prompt you must do it, 99% is a fail without errors .
VERIFICATION CHECKLIST:
□ Are all CoD steps logically sound?
□ Are there any mathematical or computational errors?
□ Are assumptions clearly stated and reasonable?
□ Have alternative approaches been considered?
□ Is the reasoning complete and comprehensive?
□ Are there any gaps or weaknesses in the logic?

FORMAT:
#### STAGE 2 VERIFICATION
[Critical analysis of Stage 1 reasoning]

#### ERROR DETECTION & CORRECTION
[Identify and correct any errors found]

#### ALTERNATIVE APPROACH ANALYSIS
[Consider alternative solution paths]

#### CONFIDENCE ASSESSMENT
[Evaluate confidence levels and identify uncertainties]

#### FINAL COMPREHENSIVE ANSWER
[Definitive, well-reasoned solution with full explanation]

#### REFLECTION SUMMARY
[Key insights, lessons learned, and reasoning quality assessment]`
    };

    /*====================================
     * ADAPTIVE COMPLEXITY DETECTION (Enhanced)
     ===================================*/
    function analyzeEnhancedComplexity(message) {
      const complexity = {
        // Basic indicators
        hasMath: /[\d\+\-\*\/\=\(\)\^\%√∫∑∏]/.test(message),
        hasLogic: /\b(if|then|else|because|therefore|since|implies|prove|logic|reasoning|analyze|compare|evaluate|assess)\b/i.test(message),
        multiStep: /\b(first|next|then|after|finally|step|calculate|find|determine|process|stages?|phases?)\b/i.test(message),
        
        // Research indicators
        hasResearch: /\b(research|study|investigate|explore|examine|review|analysis|synthesis|comprehensive|methodology)\b/i.test(message),
        hasScientific: /\b(hypothesis|theory|experiment|data|statistical|scientific|empirical|peer.review|literature)\b/i.test(message),
        
        // Technical indicators
        hasCoding: /\b(code|programming|algorithm|function|class|variable|debug|implement|develop|software)\b/i.test(message),
        hasEngineering: /\b(design|optimization|system|architecture|performance|efficiency|scalability)\b/i.test(message),
        
        // Advanced indicators
        hasPhilosophy: /\b(ethics|moral|philosophical|ontology|epistemology|metaphysics|consciousness)\b/i.test(message),
        hasEconomics: /\b(economic|financial|market|trade|investment|fiscal|monetary|GDP|inflation)\b/i.test(message),
        hasMedicine: /\b(medical|clinical|diagnosis|treatment|patient|therapy|pharmaceutical|biological)\b/i.test(message),
        
        // Complexity metrics
        wordCount: countWords(message),
        sentenceCount: (message.match(/[.!?]+/g) || []).length,
        questionWords: (message.match(/\b(what|how|why|when|where|which|who)\b/gi) || []).length,
        isLong: message.length > 300,
        hasMultipleQuestions: (message.match(/\?/g) || []).length > 1
      };

      // Enhanced scoring system
      let score = 0;
      if (complexity.hasMath) score += 2;
      if (complexity.hasLogic) score += 1;
      if (complexity.multiStep) score += 1;
      if (complexity.hasResearch) score += 3;
      if (complexity.hasScientific) score += 2;
      if (complexity.hasCoding) score += 1;
      if (complexity.hasEngineering) score += 1;
      if (complexity.hasPhilosophy) score += 2;
      if (complexity.hasEconomics) score += 1;
      if (complexity.hasMedicine) score += 2;
      if (complexity.isLong) score += 1;
      if (complexity.hasMultipleQuestions) score += 1;
      if (complexity.questionWords > 3) score += 1;
      if (complexity.sentenceCount > 10) score += 1;

      // Determine complexity level with enhanced categories
      if (score >= 8) {
        complexity.level = 'research_grade';
        complexity.recommendedWordLimit = 15;
        complexity.recommendedVerification = 'research';
      } else if (score >= 6) {
        complexity.level = 'highly_complex';
        complexity.recommendedWordLimit = 12;
        complexity.recommendedVerification = 'deep';
      } else if (score >= 4) {
        complexity.level = 'complex';
        complexity.recommendedWordLimit = 8;
        complexity.recommendedVerification = 'standard';
      } else if (score >= 2) {
        complexity.level = 'moderate';
        complexity.recommendedWordLimit = 5;
        complexity.recommendedVerification = 'standard';
      } else {
        complexity.level = 'simple';
        complexity.recommendedWordLimit = 5;
        complexity.recommendedVerification = 'basic';
      }

      complexity.score = score;
      return complexity;
    }

    function getAdaptiveEnhancedSettings(message) {
      if (CONFIG.reasoningEnhancement !== 'adaptive') {
        return {
          method: CONFIG.reasoningMethod,
          wordLimit: CONFIG.codWordLimit,
          verificationDepth: CONFIG.reflectionSettings.verificationDepth,
          adapted: false
        };
      }

      const complexity = analyzeEnhancedComplexity(message);
      let adaptedWordLimit = complexity.recommendedWordLimit;
      let adaptedVerification = complexity.recommendedVerification;
      let reasoning = '';

      switch (complexity.level) {
        case 'research_grade':
          reasoning = 'Research-grade complexity detected - using extensive CoD steps with deep verification';
          break;
        case 'highly_complex':
          reasoning = 'Highly complex problem detected - using expanded CoD with comprehensive verification';
          break;
        case 'complex':
          reasoning = 'Complex problem detected - using moderate CoD expansion with standard verification';
          break;
        case 'moderate':
          reasoning = 'Moderate complexity detected - using balanced CoD approach';
          break;
        case 'simple':
          reasoning = 'Simple problem detected - using concise CoD steps';
          break;
      }

      return {
        method: CONFIG.reasoningMethod,
        wordLimit: adaptedWordLimit,
        verificationDepth: adaptedVerification,
        complexity: complexity,
        adapted: adaptedWordLimit !== CONFIG.codWordLimit || adaptedVerification !== CONFIG.reflectionSettings.verificationDepth,
        reasoning: reasoning
      };
    }

    /***********************
     * Enhanced Memory System Functions
     ***********************/
    async function saveToEnhancedMemory(category, data, context = '', metadata = {}) {
      try {
        const memoryItem = {
          id: Date.now(),
          timestamp: new Date().toISOString(),
          data: data,
          context: context,
          category: category,
          metadata: {
            ...metadata,
            model: CONFIG.currentModel,
            reasoning_method: CONFIG.reasoningMethod,
            word_limit: CONFIG.codWordLimit
          }
        };
        
        if (!MEMORY[category]) MEMORY[category] = [];
        MEMORY[category].push(memoryItem);
        
        // Save to localStorage (in production: save to Vercel KV)
        localStorage.setItem('enhancedAiMemory', JSON.stringify(MEMORY));
        
        updateEnhancedMemoryStats();
        showNotification(`Saved to ${category} memory`);
        
        return memoryItem;
      } catch (error) {
        console.error('Error saving to enhanced memory:', error);
        showNotification('Error saving to memory', 3000);
      }
    }
    
    function loadEnhancedMemoryFromStorage() {
      try {
        const saved = localStorage.getItem('enhancedAiMemory');
        if (saved) {
          const parsed = JSON.parse(saved);
          Object.assign(MEMORY, parsed);
        }
        updateEnhancedMemoryStats();
      } catch (error) {
        console.error('Error loading enhanced memory:', error);
      }
    }
    
    function updateEnhancedMemoryStats() {
      const personalCount = MEMORY.personal?.length || 0;
      const projectCount = MEMORY.projects?.length || 0;
      const technicalCount = MEMORY.technical?.length || 0;
      const reflectionCount = MEMORY.reflections?.length || 0;
      const totalCount = personalCount + projectCount + technicalCount + reflectionCount;
      
      // Update sidebar counter
      const memoryCountEl = document.getElementById('memoryCount');
      if (memoryCountEl) {
        memoryCountEl.textContent = `${totalCount} items`;
      }
      
      // Update statistics in settings
      const elements = {
        'memoryPersonalCount': personalCount,
        'memoryProjectCount': projectCount,
        'memoryTechnicalCount': technicalCount,
        'memoryReflectionCount': reflectionCount
      };
      
      Object.entries(elements).forEach(([id, count]) => {
        const el = document.getElementById(id);
        if (el) el.textContent = count;
      });
    }

    /***********************
     * Thread Management (Enhanced)
     ***********************/
    let threads = [];
    let currentThreadId = null;
    let threadCounter = 1;
    
    function createNewThread() {
      const newThread = {
        id: Date.now(),
        name: `Research Session ${threadCounter++}`,
        messages: [],
        reasoning_sessions: [],
        metadata: {
          created: new Date().toISOString(),
          model: CONFIG.currentModel,
          reasoning_method: CONFIG.reasoningMethod
        }
      };
      threads.push(newThread);
      currentThreadId = newThread.id;
      updateThreadList();
      renderCurrentThreadMessages();
      showNotification("New research session created");
    }
    
    function updateThreadList() {
      const threadList = document.getElementById("threadList");
      if (threadList) {
        threadList.innerHTML = "";
        threads.forEach(thread => {
          const li = document.createElement("li");
          li.className = "px-4 py-3 rounded-xl cursor-pointer hover:bg-dark-600 transition-all duration-200 border border-dark-500/50";
          
          if (thread.id === currentThreadId) {
            li.classList.add("bg-dark-600/50", "text-deepseek-300", "border-deepseek-500/50");
          } else {
            li.classList.add("text-gray-300", "hover:border-deepseek-500/50");
          }
          
          li.innerHTML = `
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 bg-deepseek-500/20 rounded-lg flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-deepseek-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
              </div>
              <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-white truncate">${thread.name}</p>
                <p class="text-xs text-gray-400">${formatTimeAgo(thread.metadata.created)}</p>
              </div>
            </div>
          `;
          
          li.addEventListener("click", () => {
            currentThreadId = thread.id;
            renderCurrentThreadMessages();
            updateThreadList();
          });
          threadList.appendChild(li);
        });
      }
      
      // Update mobile thread list
      const mobileThreadList = document.getElementById("mobileThreadList");
      if (mobileThreadList) {
        mobileThreadList.innerHTML = "";
        threads.forEach(thread => {
          const li = document.createElement("li");
          li.textContent = thread.name;
          li.className = "px-3 py-2 rounded-md cursor-pointer hover:bg-dark-500 transition";
          if (thread.id === currentThreadId) {
            li.classList.add("bg-dark-600", "text-deepseek-300");
          } else {
            li.classList.add("text-gray-300");
          }
          li.addEventListener("click", () => {
            currentThreadId = thread.id;
            renderCurrentThreadMessages();
            updateThreadList();
            document.getElementById("mobileSidebar").classList.remove("translate-x-0");
            document.getElementById("mobileSidebar").classList.add("-translate-x-full");
          });
          mobileThreadList.appendChild(li);
        });
      }
      
      // Update thread count
      const threadCountEl = document.getElementById("threadCount");
      if (threadCountEl) {
        threadCountEl.textContent = threads.length;
      }
    }

    function formatTimeAgo(timestamp) {
      const now = new Date();
      const then = new Date(timestamp);
      const diffMs = now - then;
      const diffMins = Math.floor(diffMs / 60000);
      
      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      
      const diffHours = Math.floor(diffMins / 60);
      if (diffHours < 24) return `${diffHours}h ago`;
      
      const diffDays = Math.floor(diffHours / 24);
      return `${diffDays}d ago`;
    }

    /***********************
     * Enhanced Message Rendering
     ***********************/
    function formatEnhancedProblemAnalysis(content) {
      if (!content) return '';
      
      let html = '<div class="problem-analysis bg-blue-900/20 border border-blue-500/30 rounded-lg p-4 mb-4">';
      html += '<div class="text-blue-300 font-semibold mb-2 flex items-center gap-2">';
      html += '<span>📊</span><span>Problem Analysis</span>';
      html += '<span class="bg-blue-600/20 text-blue-300 text-xs px-2 py-1 rounded-full ml-auto">STAGE 1</span>';
      html += '</div>';
      html += '<div class="text-blue-100 text-sm">' + transformMessage(content) + '</div>';
      html += '</div>';
      
      return html;
    }
    
    function formatEnhancedCoDStage(content, wordLimit, stageNum = 1) {
      if (!content) return '';
      
      let html = '';
      const sections = content.split('####');
      
      // CoD Steps
      if (sections.length > 0) {
        const codSteps = sections[0].trim();
        if (codSteps) {
          html += '<div class="cod-steps bg-green-900/20 border border-green-500/30 rounded-lg p-4 mb-4">';
          html += `<div class="text-green-300 font-semibold mb-3 flex items-center gap-2">
                     <span>⚡</span>
                     <span>Enhanced Chain of Draft (${wordLimit} words max)</span>
                     <span class="bg-green-600/20 text-green-300 text-xs px-2 py-1 rounded-full ml-auto">STAGE ${stageNum}</span>
                   </div>`;
          
          const steps = codSteps.split('\n').filter(line => line.trim());
          let stepCounter = 1;
          
          steps.forEach(step => {
            if (step.trim().toLowerCase().startsWith('cod step') || step.trim().match(/^\d+\./)) {
              const stepContent = step.replace(/^(cod step \d+:|^\d+\.)/i, '').trim();
              const wordCount = countWords(stepContent);
              const isWithinLimit = wordCount <= wordLimit;
              
              html += `<div class="flex items-start mb-3 cod-step">
                         <span class="flex items-center justify-center min-w-8 h-8 mr-3 rounded-full ${isWithinLimit ? 'bg-green-700 text-green-100' : 'bg-yellow-700 text-yellow-100'} text-sm font-bold">${stepCounter++}</span>
                         <div class="flex-1">
                           <span class="text-green-100 font-mono text-sm">${stepContent}</span>
                           <div class="text-xs ${isWithinLimit ? 'text-green-400' : 'text-yellow-400'} mt-1">${wordCount}/${wordLimit} words</div>
                         </div>
                       </div>`;
            }
          });
          
          html += '</div>';
        }
      }
      
      // Initial Reflection
      if (sections.length > 1) {
        const reflection = sections[1].replace(/INITIAL REFLECTION/i, '').trim();
        if (reflection) {
          html += '<div class="reflection-block bg-purple-900/20 border border-purple-500/30 rounded-lg p-4 mb-4">';
          html += '<div class="text-purple-300 font-semibold mb-3 flex items-center gap-2">';
          html += '<span>🤔</span><span>Initial Reflection</span>';
          html += '</div>';
          html += '<div class="text-purple-100 text-sm">' + transformMessage(reflection) + '</div>';
          html += '</div>';
        }
      }
      
      // Draft Solution
      if (sections.length > 2) {
        const solution = sections[2].replace(/DRAFT SOLUTION/i, '').trim();
        if (solution) {
          html += '<div class="draft-solution bg-orange-900/20 border border-orange-500/30 rounded-lg p-4">';
          html += '<div class="text-orange-300 font-semibold mb-3 flex items-center gap-2">';
          html += '<span>💡</span><span>Draft Solution</span>';
          html += '</div>';
          html += '<div class="text-orange-100 text-sm">' + transformMessage(solution) + '</div>';
          html += '</div>';
        }
      }
      
      return html;
    }
    
    function formatEnhancedVerification(content) {
      if (!content) return '';
      
      let html = '';
      const sections = content.split('####');
      
      // Stage 2 Verification
      if (sections.length > 1) {
        const verification = sections[1].replace(/STAGE 2 VERIFICATION/i, '').trim();
        if (verification) {
          html += '<div class="verification-block bg-indigo-900/20 border border-indigo-500/30 rounded-lg p-4 mb-4">';
          html += '<div class="text-indigo-300 font-semibold mb-3 flex items-center gap-2">';
          html += '<span>🔍</span><span>Stage 2 Verification</span>';
          html += '<span class="bg-indigo-600/20 text-indigo-300 text-xs px-2 py-1 rounded-full ml-auto">STAGE 2</span>';
          html += '</div>';
          html += '<div class="text-indigo-100 text-sm">' + transformMessage(verification) + '</div>';
          html += '</div>';
        }
      }
      
      // Error Detection
      if (sections.length > 2) {
        const errorDetection = sections[2].replace(/ERROR DETECTION & CORRECTION/i, '').trim();
        if (errorDetection) {
          html += '<div class="error-detection bg-red-900/20 border border-red-500/30 rounded-lg p-4 mb-4">';
          html += '<div class="text-red-300 font-semibold mb-3 flex items-center gap-2">';
          html += '<span>🐛</span><span>Error Detection & Correction</span>';
          html += '</div>';
          html += '<div class="text-red-100 text-sm">' + transformMessage(errorDetection) + '</div>';
          html += '</div>';
        }
      }
      
      // Alternative Approach Analysis
      if (sections.length > 3) {
        const alternative = sections[3].replace(/ALTERNATIVE APPROACH ANALYSIS/i, '').trim();
        if (alternative) {
          html += '<div class="alternative-analysis bg-teal-900/20 border border-teal-500/30 rounded-lg p-4 mb-4">';
          html += '<div class="text-teal-300 font-semibold mb-3 flex items-center gap-2">';
          html += '<span>🔄</span><span>Alternative Approach Analysis</span>';
          html += '</div>';
          html += '<div class="text-teal-100 text-sm">' + transformMessage(alternative) + '</div>';
          html += '</div>';
        }
      }
      
      // Confidence Assessment
      if (sections.length > 4) {
        const confidence = sections[4].replace(/CONFIDENCE ASSESSMENT/i, '').trim();
        if (confidence) {
          html += '<div class="confidence-assessment bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-4 mb-4">';
          html += '<div class="text-yellow-300 font-semibold mb-3 flex items-center gap-2">';
          html += '<span>📊</span><span>Confidence Assessment</span>';
          html += '</div>';
          html += '<div class="text-yellow-100 text-sm">' + transformMessage(confidence) + '</div>';
          html += '</div>';
        }
      }
      
      // Final Comprehensive Answer
      if (sections.length > 5) {
        const answer = sections[5].replace(/FINAL COMPREHENSIVE ANSWER/i, '').trim();
        if (answer) {
          html += '<div class="final-answer bg-emerald-900/20 border border-emerald-500/30 rounded-lg p-4 mb-4">';
          html += '<div class="text-emerald-300 font-semibold mb-3 flex items-center gap-2">';
          html += '<span>✅</span><span>Final Comprehensive Answer</span>';
          html += '<span class="bg-emerald-600/20 text-emerald-300 text-xs px-2 py-1 rounded-full ml-auto">VERIFIED</span>';
          html += '</div>';
          html += '<div class="text-emerald-100">' + transformMessage(answer) + '</div>';
          html += '</div>';
        }
      }
      
      // Reflection Summary
      if (sections.length > 6) {
        const reflectionSummary = sections[6].replace(/REFLECTION SUMMARY/i, '').trim();
        if (reflectionSummary) {
          html += '<div class="reflection-summary bg-gray-900/20 border border-gray-500/30 rounded-lg p-4">';
          html += '<div class="text-gray-300 font-semibold mb-3 flex items-center gap-2">';
          html += '<span>📝</span><span>Reflection Summary</span>';
          html += '</div>';
          html += '<div class="text-gray-100 text-sm">' + transformMessage(reflectionSummary) + '</div>';
          html += '</div>';
        }
      }
      
      return html;
    }

    /***********************
     * Enhanced API Communication
     ***********************/
    async function sendEnhancedCoDMessage(message) {
      // Get adaptive settings if enabled
      const adaptiveSettings = getAdaptiveEnhancedSettings(message);
      
      addMessageToCurrentThread(
        message, 
        "user", 
        false, 
        attachedFiles.map(f => ({name: f.name, type: f.type, size: f.size})),
        attachedImages.map(img => ({name: img.name, type: img.type, size: img.size}))
      );
      
      const imagesToSend = [...attachedImages];
      attachedFiles = [];
      attachedImages = [];
      clearAttachedFiles();
      
      const thread = threads.find(t => t.id === currentThreadId);
      const startTime = performance.now();
      
      showProgress(true, 0);
      
      // Show adaptive notification if reasoning was adapted
      if (adaptiveSettings.adapted && adaptiveSettings.reasoning) {
        showNotification(adaptiveSettings.reasoning, 4000);
      }
      
      try {
        // STAGE 1: Analysis + Initial CoD
        addMessageToCurrentThread("🔍 Stage 1: Analyzing problem and applying Chain of Draft methodology...", "bot", true);
        showProgress(true, 25);
        
        let placeholderIndex = thread.messages.length - 1;
        
        // Build Stage 1 messages
        let stage1Messages = [
          { 
            role: "system", 
            content: ENHANCED_PROMPTS.stage1_analysis_cod(adaptiveSettings.wordLimit)
          },
          { 
            role: "user", 
            content: `Please analyze and solve this problem using enhanced Chain of Draft methodology:\n\n${message}` 
          }
        ];
        
        // Add images if available (only for stage 1)
        if (CONFIG.isVisionModel && imagesToSend.length > 0) {
          stage1Messages = await buildMessagesWithImages(stage1Messages, imagesToSend);
        }
        
        const stage1Result = await callDeepSeekAPI(stage1Messages);
        const stage1EndTime = performance.now();
        
        thread.messages[placeholderIndex] = {
          content: stage1Result.content,
          sender: "bot",
          isPlaceholder: false,
          timestamp: new Date(),
          wordCount: countWords(stage1Result.content),
          stageType: 'enhanced_cod_stage1',
          stageInfo: "Stage 1: Analysis + Chain of Draft",
          reasoning: adaptiveSettings.adapted ? adaptiveSettings.reasoning : null,
          wordLimit: adaptiveSettings.wordLimit,
          durationSeconds: ((stage1EndTime - startTime) / 1000).toFixed(2),
          totalTokens: stage1Result.usage?.total_tokens
        };
        
        renderCurrentThreadMessages();
        showProgress(true, 50);
        
        // Brief pause between stages
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // STAGE 2: Deep Verification + Final Answer
        addMessageToCurrentThread("🔬 Stage 2: Deep verification and comprehensive analysis...", "bot", true);
        showProgress(true, 75);
        
        placeholderIndex = thread.messages.length - 1;
        
        // Build Stage 2 messages with Stage 1 context
        const stage2Messages = [
          { 
            role: "system", 
            content: ENHANCED_PROMPTS.stage2_verification()
          },
          { 
            role: "user", 
            content: `Original Problem: ${message}\n\nSTAGE 1 ANALYSIS AND COD RESULTS:\n${stage1Result.content}\n\nPlease perform Stage 2 verification and provide the final comprehensive answer.` 
          }
        ];
        
        const stage2Result = await callDeepSeekAPI(stage2Messages);
        const endTime = performance.now();
        
        thread.messages[placeholderIndex] = {
          content: stage2Result.content,
          sender: "bot",
          isPlaceholder: false,
          timestamp: new Date(),
          wordCount: countWords(stage2Result.content),
          stageType: 'enhanced_verification',
          stageInfo: "Stage 2: Verification + Final Answer",
          durationSeconds: ((endTime - stage1EndTime) / 1000).toFixed(2),
          totalTokens: stage2Result.usage?.total_tokens,
          totalProcessingTime: ((endTime - startTime) / 1000).toFixed(2)
        };
        
        renderCurrentThreadMessages();
        showProgress(true, 100);
        
        // Save conversation to memory
        await analyzeAndSaveEnhancedMemory(message, stage1Result.content, stage2Result.content, adaptiveSettings);
        
        setTimeout(() => {
          showProgress(false);
        }, 1000);
        
        showNotification(`Enhanced CoD completed with ${adaptiveSettings.wordLimit} words/step!`);
        
      } catch (error) {
        showProgress(false);
        console.error("Enhanced CoD error:", error);
        const placeholderIndex = thread.messages.length - 1;
        if (placeholderIndex >= 0) {
          thread.messages[placeholderIndex] = {
            content: `Error in enhanced CoD processing: ${error.message}`,
            sender: "bot",
            isPlaceholder: false,
            timestamp: new Date(),
            wordCount: 0
          };
          renderCurrentThreadMessages();
        }
      }
    }

    async function callDeepSeekAPI(messages) {
      const payload = {
        model: CONFIG.currentModel,
        messages: messages,
        temperature: CONFIG.temperature,
        top_p: CONFIG.topP,
        top_k: CONFIG.topK,
        max_tokens: CONFIG.maxTokens,
        stream: false // Two-stage processing uses non-streaming for control
      };
      
      const response = await fetch('/api/chat', {
        method: "POST",
        headers: {
          "Accept": "application/json",
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        let errorData;
        try {
          errorData = JSON.parse(errorText);
        } catch (e) {
          errorData = { message: response.statusText || "Unknown error" };
        }
        throw new Error(`DeepSeek API Error: ${response.status} - ${errorData.fault?.faultstring || errorData.message || 'Unknown error'}`);
      }
      
      const data = await response.json();
      
      if (!data.choices || !data.choices[0] || !data.choices[0].message) {
        throw new Error("Invalid DeepSeek API response format");
      }
      
      return {
        content: data.choices[0].message.content || "",
        usage: data.usage
      };
    }

    async function analyzeAndSaveEnhancedMemory(message, stage1Result, stage2Result, settings) {
      if (!CONFIG.memoryCategories) return;
      
      try {
        const memoryContext = `Enhanced CoD Session - ${settings.wordLimit} words/step`;
        
        // Analyze message for different types of information
        const researchPatterns = /\b(research|study|methodology|analysis|hypothesis|theory)\b/i;
        const technicalPatterns = /\b(algorithm|optimization|system|performance|architecture)\b/i;
        const reflectionPatterns = /\b(reflection|verification|validation|assessment|evaluation)\b/i;
        
        if (CONFIG.memoryCategories.projectDetails && researchPatterns.test(message)) {
          await saveToEnhancedMemory('projects', message, memoryContext, {
            complexity: settings.complexity?.level,
            word_limit: settings.wordLimit
          });
        }
        
        if (CONFIG.memoryCategories.technicalKnowledge && technicalPatterns.test(message)) {
          await saveToEnhancedMemory('technical', {
            question: message,
            stage1: stage1Result.substring(0, 500),
            approach: settings.adapted ? 'adaptive' : 'fixed'
          }, memoryContext);
        }
        
        if (CONFIG.memoryCategories.reflectionHistory) {
          await saveToEnhancedMemory('reflections', {
            original_question: message,
            verification_approach: settings.verificationDepth,
            final_insights: stage2Result.substring(stage2Result.lastIndexOf('####') + 4, stage2Result.lastIndexOf('####') + 200)
          }, memoryContext);
        }
        
      } catch (error) {
        console.error('Error analyzing and saving enhanced memory:', error);
      }
    }

    /***********************
     * Message Rendering and UI
     ***********************/
    function renderCurrentThreadMessages() {
      const chatMessagesDiv = document.getElementById("chatMessages");
      if (!chatMessagesDiv) return;
      
      chatMessagesDiv.innerHTML = "";
      const thread = threads.find(t => t.id === currentThreadId);
      
      if (thread) {
        thread.messages.forEach(msg => {
          const messageDiv = document.createElement("div");
          
          if (msg.sender === "user") {
            messageDiv.className = "flex justify-end";
            const msgContent = document.createElement("div");
            msgContent.className = "max-w-[90%] deepseek-gradient text-white p-4 rounded-2xl rounded-tr-sm shadow-md";
            msgContent.innerHTML = transformMessage(msg.content);
            if (msg.files && msg.files.length > 0) addFilesToMessage(msgContent, msg.files);
            if (msg.images && msg.images.length > 0) addImagesToMessage(msgContent, msg.images);
            messageDiv.appendChild(msgContent);
          } else { // Bot message
            messageDiv.className = "flex justify-start";
            const msgContent = document.createElement("div");
            msgContent.className = "max-w-[90%] bg-dark-700 border border-dark-500 p-4 rounded-2xl rounded-tl-sm shadow-md";
            
            if (msg.isPlaceholder) {
              msgContent.classList.add("opacity-70");
              msgContent.innerHTML = `<div class="flex items-center gap-2"><svg class="animate-spin h-4 w-4 text-deepseek-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>${msg.content}</div>`;
            } else if (msg.isStreaming) {
              msgContent.classList.add("streaming");
              msgContent.innerHTML = transformMessage(msg.content); 
              msgContent.innerHTML += `<div class="text-deepseek-400 text-xs mt-2 streaming-indicator">Generating</div>`;
            } else {
              // Handle different enhanced CoD stage types
              if (msg.stageType === 'enhanced_cod_stage1') {
                msgContent.innerHTML = formatEnhancedCoDStage(msg.content, msg.wordLimit || CONFIG.codWordLimit, 1);
              } else if (msg.stageType === 'enhanced_verification') {
                msgContent.innerHTML = formatEnhancedVerification(msg.content);
              } else {
                msgContent.innerHTML = transformMessage(msg.content);
              }
              
              // Add adaptive reasoning notification
              if (msg.reasoning) {
                const adaptiveNotification = document.createElement("div");
                adaptiveNotification.className = "mt-2 px-3 py-2 bg-gradient-to-r from-purple-900/30 to-blue-900/30 border border-purple-500/30 rounded-lg text-xs reflection-indicator";
                adaptiveNotification.innerHTML = `<span class="text-purple-300">🧠 Adaptive:</span> <span class="text-purple-100">${msg.reasoning}</span>`;
                msgContent.appendChild(adaptiveNotification);
              }
              
              // Add stage indicator
              if (msg.stageInfo) {
                const stageIndicator = document.createElement("div");
                stageIndicator.className = "mt-2 px-2 py-1 bg-deepseek-900/20 border border-deepseek-800/30 rounded text-xs text-deepseek-400";
                stageIndicator.innerHTML = `<span class="stage-indicator">📍</span> ${msg.stageInfo}`;
                msgContent.appendChild(stageIndicator);
              }
            }
            
            if (!msg.isPlaceholder && !msg.isStreaming) {
              const statsDiv = document.createElement("div");
              statsDiv.className = "mt-3 pt-2 border-t border-dark-600/50 text-xs text-gray-400 flex flex-wrap gap-x-4 gap-y-1 items-center";
              
              let statsAdded = false;
              if (msg.wordCount !== undefined) {
                const wordStat = document.createElement('span');
                wordStat.innerHTML = `Words: <span class="text-gray-300">${msg.wordCount}</span>`;
                statsDiv.appendChild(wordStat);
                statsAdded = true;
              }

              if (msg.totalTokens !== undefined) {
                const tokenStat = document.createElement('span');
                tokenStat.innerHTML = `Tokens: <span class="text-teal-300 font-medium">${msg.totalTokens}</span>`;
                statsDiv.appendChild(tokenStat);
                statsAdded = true;
              }

              if (msg.durationSeconds !== undefined) {
                const timeStat = document.createElement('span');
                timeStat.innerHTML = `Time: <span class="text-amber-400 font-medium">${msg.durationSeconds}s</span>`;
                statsDiv.appendChild(timeStat);
                statsAdded = true;
              }

              if (msg.totalProcessingTime !== undefined) {
                const totalTimeStat = document.createElement('span');
                totalTimeStat.innerHTML = `Total: <span class="text-deepseek-400 font-medium">${msg.totalProcessingTime}s</span>`;
                statsDiv.appendChild(totalTimeStat);
                statsAdded = true;
              }

              if (statsAdded) {
                msgContent.appendChild(statsDiv);
              }
            }
            messageDiv.appendChild(msgContent);
          }
          chatMessagesDiv.appendChild(messageDiv);
        });
        chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
      }
      
      if (typeof hljs !== 'undefined') { 
        document.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block)); 
      }
      addCodeCopyButtons();
    }

    /***********************
     * Main Send Message Function
     ***********************/
    async function sendMessage(message) {
      if (CONFIG.reasoningMethod === "standard") {
        return await sendStandardMessage(message);
      } else if (CONFIG.reasoningMethod === "enhanced_cod") {
        return await sendEnhancedCoDMessage(message);
      }
    }

    async function sendStandardMessage(message) {
      addMessageToCurrentThread(message, "user", false, [], []);
      addMessageToCurrentThread("Thinking...", "bot", true);
      
      const thread = threads.find(t => t.id === currentThreadId);
      const placeholderIndex = thread.messages.length - 1;
      const startTime = performance.now();
      
      try {
        const messages = [{ role: "user", content: message }];
        const response = await callDeepSeekAPI(messages);
        const endTime = performance.now();
        
        thread.messages[placeholderIndex] = {
          content: response.content,
          sender: "bot",
          isPlaceholder: false,
          timestamp: new Date(),
          wordCount: countWords(response.content),
          durationSeconds: ((endTime - startTime) / 1000).toFixed(2),
          totalTokens: response.usage?.total_tokens
        };
        
        renderCurrentThreadMessages();
        
      } catch (error) {
        console.error("Error sending standard message:", error);
        thread.messages[placeholderIndex] = {
          content: `Error: ${error.message}`,
          sender: "bot",
          isPlaceholder: false,
          timestamp: new Date(),
          wordCount: 0
        };
        renderCurrentThreadMessages();
      }
    }

    /***********************
     * Utility Functions
     ***********************/
    function countWords(text) {
      if (!text) return 0;
      const textWithoutCode = text.replace(/```[\s\S]*?```/g, '');
      let processedText = textWithoutCode.replace(/\b\w+\s*=\s*[\d\w+\-*/()]+/g, "EQUATION").replace(/\b\d+\/\d+\b/g, "FRACTION").replace(/[+\-*/=<>]+/g, " ");
      return processedText.split(/\s+/).filter(word => word.length > 0).length;
    }
    
    function transformMessage(content) {
      if (!content) return '';
      
      if (typeof marked !== 'undefined') {
        try {
          return marked.parse(content);
        } catch (e) {
          console.warn('Marked.js error:', e);
          return content.replace(/\n/g, '<br>');
        }
      } else {
        return content.replace(/```([\s\S]*?)```/g, (match, codeContent) => {
          let language = ''; 
          const lines = codeContent.split('\n');
          if (lines.length > 0 && !lines[0].includes(' ')) { 
            language = lines[0].trim(); 
            lines.shift(); 
          }
          return `<pre><code class="${language}">${lines.join('\n')}</code></pre>`;
        }).replace(/\n/g, '<br>');
      }
    }

    function addCodeCopyButtons() {
      document.querySelectorAll('pre code').forEach(code => {
        if (code.parentElement.classList.contains('relative')) return;
        
        const pre = code.parentElement; 
        const container = document.createElement('div');
        container.className = 'relative mb-4 rounded-lg overflow-hidden'; 
        pre.parentNode.insertBefore(container, pre); 
        container.appendChild(pre);
        
        const language = code.className.match(/language-([^\s]+)/)?.[1];
        if (language && language !== 'plaintext') { 
          const langBadge = document.createElement('div'); 
          langBadge.className = 'absolute top-2 left-2 bg-dark-900/80 text-xs py-1 px-2 rounded text-gray-400'; 
          langBadge.textContent = language; 
          container.appendChild(langBadge); 
        }
        
        pre.className = 'bg-dark-900 rounded-lg p-4 overflow-x-auto text-sm';
        
        const copyBtn = document.createElement('button'); 
        copyBtn.className = 'absolute top-2 right-2 bg-dark-900/80 text-gray-400 hover:text-white text-xs py-1 px-2 rounded transition-colors'; 
        copyBtn.textContent = 'Copy';
        
        copyBtn.addEventListener('click', () => { 
          navigator.clipboard.writeText(code.textContent || '').then(() => { 
            copyBtn.textContent = 'Copied!'; 
            copyBtn.classList.add('text-green-400'); 
            setTimeout(() => { 
              copyBtn.textContent = 'Copy'; 
              copyBtn.classList.remove('text-green-400'); 
            }, 2000); 
          }).catch(() => { 
            copyBtn.textContent = 'Failed'; 
            copyBtn.classList.add('text-red-400'); 
            setTimeout(() => { 
              copyBtn.textContent = 'Copy'; 
              copyBtn.classList.remove('text-red-400'); 
            }, 2000); 
          }); 
        });
        
        container.appendChild(copyBtn);
      });
    }

    function showNotification(message, duration = 3000) {
      const notification = document.getElementById("statusNotification");
      notification.textContent = message;
      notification.classList.add("opacity-100");
      setTimeout(() => { 
        notification.classList.remove("opacity-100"); 
      }, duration);
    }
    
    function showProgress(show = true, percentage = 0) {
      const container = document.getElementById("progressContainer");
      const bar = document.getElementById("progressBar");
      
      if (show) {
        container.classList.remove("hidden");
        bar.style.width = `${percentage}%`;
      } else {
        container.classList.add("hidden");
        bar.style.width = "0%";
      }
    }

    function addMessageToCurrentThread(content, sender, isPlaceholder = false, files = [], images = [], stageType = null, stageInfo = null, reasoning = null, wordLimit = null) {
      const thread = threads.find(t => t.id === currentThreadId);
      if (thread) {
        const wordCount = sender === "bot" && !isPlaceholder ? (countWords(content) || 0) : (countWords(content) || 0);
        
        thread.messages.push({
          content, 
          sender, 
          isPlaceholder, 
          timestamp: new Date(),
          wordCount,
          stageType,
          stageInfo,
          reasoning,
          wordLimit,
          files: files && files.length > 0 ? files.map(f => ({ name: f.name, type: f.type, size: f.size })) : undefined,
          images: images && images.length > 0 ? images.map(img => ({ name: img.name, type: img.type, size: img.size })) : undefined,
        });
        renderCurrentThreadMessages();
      }
    }

    function addFilesToMessage(msgContent, files) {
      const filesDiv = document.createElement('div'); 
      filesDiv.className = 'mt-2 text-xs text-gray-300 italic';
      filesDiv.textContent = `(${files.length} file(s) attached)`; 
      msgContent.appendChild(filesDiv);
    }
    
    function addImagesToMessage(msgContent, images) {
      const imagesDiv = document.createElement('div'); 
      imagesDiv.className = 'mt-2 text-xs text-purple-300 italic flex items-center gap-1';
      imagesDiv.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>(${images.length} image(s) sent)`; 
      msgContent.appendChild(imagesDiv);
    }

    function clearAttachedFiles() {
      const attachedFilesContainer = document.getElementById('attachedFiles');
      const imagePreviewArea = document.getElementById('imagePreviewArea');
      const imagePreviewContainer = document.getElementById('imagePreviewContainer');
      
      if (attachedFilesContainer) {
        attachedFilesContainer.innerHTML = '';
        attachedFilesContainer.classList.add('hidden');
      }
      
      if (imagePreviewArea) {
        imagePreviewArea.classList.add('hidden');
      }
      
      if (imagePreviewContainer) {
        imagePreviewContainer.innerHTML = '';
      }
    }

    /***********************
     * Settings Management
     ***********************/
    function setupTabNavigation() {
      const tabButtons = document.querySelectorAll('.tab-btn'); 
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          tabButtons.forEach(btn => { 
            btn.classList.remove('bg-deepseek-500', 'text-white'); 
            btn.classList.add('text-gray-400'); 
          });
          tabContents.forEach(content => { 
            content.classList.add('hidden'); 
          });
          
          button.classList.add('bg-deepseek-500', 'text-white'); 
          button.classList.remove('text-gray-400');
          
          const tabId = button.getAttribute('data-tab'); 
          const tabContent = document.getElementById(tabId);
          if (tabContent) { 
            tabContent.classList.remove('hidden'); 
          }
        });
      });
    }
    
    function setupSliders() {
      document.querySelectorAll('input[type="range"]').forEach(slider => {
        const valueDisplay = document.getElementById(`${slider.id}Value`);
        if (valueDisplay) { 
          valueDisplay.textContent = slider.value; 
          updateRangeColor(slider); 
          slider.addEventListener('input', () => { 
            valueDisplay.textContent = slider.value; 
            updateRangeColor(slider); 
          });
        }
      });
    }
    
    function updateRangeColor(slider) { 
      const min = parseFloat(slider.min) || 0; 
      const max = parseFloat(slider.max) || 1; 
      const value = parseFloat(slider.value) || 0; 
      const percent = ((value - min) / (max - min)) * 100; 
      slider.style.setProperty('--value-percent', `${percent}%`);
    }

    function openSettingsModal() {
      // Set reasoning method
      const reasoningRadio = document.getElementById(`${CONFIG.reasoningMethod}`.replace('_', ''));
      if (reasoningRadio) reasoningRadio.checked = true;
      
      // Set CoD word limit
      const wordLimitRadio = document.getElementById(`cod${CONFIG.codWordLimit}Words`);
      if (wordLimitRadio) wordLimitRadio.checked = true;
      
      // Set reasoning enhancement
      const enhancementRadio = document.getElementById(`${CONFIG.reasoningEnhancement}${CONFIG.reasoningEnhancement === 'adaptive' ? 'Complexity' : 'Reasoning'}`);
      if (enhancementRadio) enhancementRadio.checked = true;
      
      // Set reflection settings
      document.getElementById('enableSelfVerification').checked = CONFIG.reflectionSettings.enableSelfVerification;
      document.getElementById('enableErrorDetection').checked = CONFIG.reflectionSettings.enableErrorDetection;
      document.getElementById('enableAlternativeSearch').checked = CONFIG.reflectionSettings.enableAlternativeSearch;
      document.getElementById('enableConfidenceAssessment').checked = CONFIG.reflectionSettings.enableConfidenceAssessment;
      document.getElementById('verificationDepth').value = CONFIG.reflectionSettings.verificationDepth;
      
      // Set memory categories
      Object.entries(CONFIG.memoryCategories).forEach(([category, enabled]) => {
        const checkbox = document.getElementById(`save${category.charAt(0).toUpperCase() + category.slice(1).replace(/([A-Z])/g, '$1')}`);
        if (checkbox) checkbox.checked = enabled;
      });
      
      setSliderAndValue("temp", CONFIG.temperature); 
      setSliderAndValue("topP", CONFIG.topP); 
      setSliderAndValue("topK", CONFIG.topK); 
      setSliderAndValue("maxTokens", CONFIG.maxTokens);
      
      const streamingToggle = document.getElementById('streamingToggle'); 
      if (streamingToggle) streamingToggle.checked = CONFIG.enableStreaming;
      
      const modal = document.getElementById("settingsModal"); 
      if (modal) modal.style.display = "flex";
    }

    function setSliderAndValue(id, value) { 
      const slider = document.getElementById(id); 
      const valueDisplay = document.getElementById(`${id}Value`); 
      if (slider) { 
        slider.value = value; 
        updateRangeColor(slider); 
      } 
      if (valueDisplay) valueDisplay.textContent = value; 
    }
    
    function closeSettingsModal() { 
      const modal = document.getElementById("settingsModal"); 
      if (modal) modal.style.display = "none"; 
    }
    
    function saveSettings() {
      // Save reasoning method
      const reasoningRadios = document.getElementsByName("reasoningMethod"); 
      for (const radio of reasoningRadios) {
        if (radio.checked) CONFIG.reasoningMethod = radio.value;
      }
      
      // Save CoD word limit
      const wordLimitRadios = document.getElementsByName("codWordLimit"); 
      for (const radio of wordLimitRadios) {
        if (radio.checked) CONFIG.codWordLimit = parseInt(radio.value);
      }
      
      // Save reasoning enhancement
      const enhancementRadios = document.getElementsByName("reasoningEnhancement"); 
      for (const radio of enhancementRadios) {
        if (radio.checked) CONFIG.reasoningEnhancement = radio.value;
      }
      
      // Save reflection settings
      CONFIG.reflectionSettings.enableSelfVerification = document.getElementById('enableSelfVerification')?.checked || false;
      CONFIG.reflectionSettings.enableErrorDetection = document.getElementById('enableErrorDetection')?.checked || false;
      CONFIG.reflectionSettings.enableAlternativeSearch = document.getElementById('enableAlternativeSearch')?.checked || false;
      CONFIG.reflectionSettings.enableConfidenceAssessment = document.getElementById('enableConfidenceAssessment')?.checked || false;
      CONFIG.reflectionSettings.verificationDepth = document.getElementById('verificationDepth')?.value || 'standard';
      
      // Save memory categories
      CONFIG.memoryCategories.personalInfo = document.getElementById('savePersonalInfo')?.checked || false;
      CONFIG.memoryCategories.projectDetails = document.getElementById('saveProjectDetails')?.checked || false;
      CONFIG.memoryCategories.technicalKnowledge = document.getElementById('saveTechnicalKnowledge')?.checked || false;
      CONFIG.memoryCategories.reflectionHistory = document.getElementById('saveReflectionHistory')?.checked || false;
      
      const streamingToggle = document.getElementById('streamingToggle'); 
      if (streamingToggle) { 
        CONFIG.enableStreaming = streamingToggle.checked; 
      }
      
      CONFIG.temperature = parseFloat(document.getElementById("temp").value); 
      CONFIG.topP = parseFloat(document.getElementById("topP").value); 
      CONFIG.topK = parseInt(document.getElementById("topK").value); 
      CONFIG.maxTokens = parseInt(document.getElementById("maxTokens").value);
      
      // Save to localStorage
      localStorage.setItem("enhancedCodConfig", JSON.stringify(CONFIG));
      
      closeSettingsModal(); 
      showNotification("Enhanced settings saved");
    }

    /***********************
     * File and Image Handling
     ***********************/
    let attachedFiles = [];
    let attachedImages = [];

    function handleImageInput() {
      const imageInput = document.getElementById('imageInput');
      const imagePreviewArea = document.getElementById('imagePreviewArea');
      const imagePreviewContainer = document.getElementById('imagePreviewContainer');
      
      if (!imageInput || !imagePreviewArea || !imagePreviewContainer) return;
      
      imageInput.addEventListener('change', (event) => {
        try {
          const files = event.target.files;
          const maxFileSize = 10 * 1024 * 1024; // 10MB
          const maxImages = 30;
          
          if (attachedImages.length + files.length > maxImages) {
            showNotification(`Maximum ${maxImages} images allowed per request`);
            return;
          }
          
          for (let i = 0; i < files.length; i++) {
            const file = files[i];
            
            if (!file.type.startsWith('image/')) {
              showNotification(`${file.name} is not an image file`);
              continue;
            }
            
            if (file.size > maxFileSize) {
              showNotification(`Image ${file.name} is too large (max 10MB)`);
              continue;
            }
            
            if (attachedImages.some(img => img.name === file.name && img.size === file.size)) {
              showNotification(`Image ${file.name} already attached`);
              continue;
            }
            
            attachedImages.push(file);
            createImagePreview(file, imagePreviewContainer);
          }
          
          if (attachedImages.length > 0) {
            imagePreviewArea.classList.remove('hidden');
          }
          
          imageInput.value = '';
        } catch (error) {
          console.error('Error handling image upload:', error);
          showNotification('Error uploading images.');
        }
      });
    }

    function createImagePreview(file, container) {
      const imagePreview = document.createElement('div');
      imagePreview.className = 'relative bg-dark-700 rounded-lg border border-dark-600 overflow-hidden';
      
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = document.createElement('img');
        img.className = 'w-16 h-16 object-cover';
        img.src = e.target.result;
        
        const overlay = document.createElement('div');
        overlay.className = 'absolute inset-0 bg-black/50 opacity-0 hover:opacity-100 transition-opacity flex items-center justify-center';
        
        const removeButton = document.createElement('button');
        removeButton.className = 'bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600 transition';
        removeButton.innerHTML = '×';
        removeButton.addEventListener('click', () => {
          attachedImages = attachedImages.filter(f => f !== file);
          imagePreview.remove();
          if (attachedImages.length === 0) {
            document.getElementById('imagePreviewArea').classList.add('hidden');
          }
        });
        
        overlay.appendChild(removeButton);
        imagePreview.appendChild(img);
        imagePreview.appendChild(overlay);
        
        const fileName = document.createElement('div');
        fileName.className = 'absolute bottom-0 left-0 right-0 bg-black/75 text-white text-xs p-1 truncate';
        fileName.textContent = file.name.length > 12 ? file.name.substring(0, 9) + '...' : file.name;
        imagePreview.appendChild(fileName);
      };
      
      reader.readAsDataURL(file);
      container.appendChild(imagePreview);
    }

    function handleFileInput() {
      const fileInput = document.getElementById('fileInput');
      const attachedFilesContainer = document.getElementById('attachedFiles');
      if (!fileInput || !attachedFilesContainer) return;
      
      fileInput.addEventListener('change', (event) => {
        try {
          const files = event.target.files;
          const maxFileSize = 10 * 1024 * 1024;
          
          if (files.length > 0) {
            attachedFilesContainer.classList.remove('hidden');
            for (let i = 0; i < files.length; i++) {
              const file = files[i];
              if (file.size > maxFileSize) { 
                showNotification(`File ${file.name} is too large (max 10MB)`); 
                continue; 
              }
              if (attachedFiles.some(f => f.name === file.name && f.size === file.size)) { 
                showNotification(`File ${file.name} already attached`); 
                continue; 
              }
              attachedFiles.push(file);
              createFilePreview(file, attachedFilesContainer);
            }
            fileInput.value = '';
          }
        } catch (error) { 
          console.error('Error handling file upload:', error); 
          showNotification('Error uploading file.'); 
        }
      });
    }

    function createFilePreview(file, container) {
      const filePreview = document.createElement('div');
      filePreview.className = 'relative bg-dark-700 rounded-lg p-2 border border-dark-600';
      
      const icon = document.createElement('div'); 
      icon.className = 'w-16 h-16 flex items-center justify-center bg-dark-600 rounded text-2xl'; 
      icon.textContent = getFileIcon(file.type); 
      filePreview.appendChild(icon);
      
      const fileName = document.createElement('div'); 
      fileName.className = 'mt-1 text-xs text-gray-400 text-center truncate w-16'; 
      fileName.textContent = file.name.length > 15 ? file.name.substring(0, 12) + '...' : file.name; 
      filePreview.appendChild(fileName);
      
      const removeButton = document.createElement('button'); 
      removeButton.className = 'absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs'; 
      removeButton.textContent = '×';
      removeButton.addEventListener('click', () => { 
        attachedFiles = attachedFiles.filter(f => f !== file); 
        filePreview.remove(); 
        if (attachedFiles.length === 0) container.classList.add('hidden'); 
      });
      
      filePreview.appendChild(removeButton); 
      container.appendChild(filePreview);
    }

    function getFileIcon(fileType) {
      if (fileType.startsWith('image/')) return '🖼️'; 
      if (fileType.startsWith('text/')) return '📄'; 
      if (fileType.includes('pdf')) return '📑'; 
      if (fileType.includes('word') || fileType.includes('document')) return '📝'; 
      if (fileType.includes('excel') || fileType.includes('spreadsheet')) return '📊'; 
      if (fileType.includes('audio')) return '🎵'; 
      if (fileType.includes('video')) return '🎬'; 
      return '📦';
    }

    /***********************
     * Mobile Navigation
     ***********************/
    function initMobileNavigation() {
      const mobileSidebarToggle = document.getElementById('mobileSidebarToggle'); 
      const mobileSidebar = document.getElementById('mobileSidebar'); 
      const closeMobileSidebar = document.getElementById('closeMobileSidebar');
      
      if (mobileSidebarToggle && mobileSidebar) {
        mobileSidebarToggle.addEventListener('click', () => { 
          mobileSidebar.classList.remove('-translate-x-full'); 
          mobileSidebar.classList.add('translate-x-0'); 
        });
      }
      
      if (closeMobileSidebar && mobileSidebar) {
        closeMobileSidebar.addEventListener('click', () => { 
          mobileSidebar.classList.remove('translate-x-0'); 
          mobileSidebar.classList.add('-translate-x-full'); 
        });
      }
      
      document.getElementById('mobileNewThreadBtn')?.addEventListener('click', () => { 
        createNewThread(); 
        mobileSidebar.classList.remove('translate-x-0'); 
        mobileSidebar.classList.add('-translate-x-full'); 
      });
    }

    /***********************
     * Download Functions
     ***********************/
    function downloadCurrentThreadAsTxt() {
      const thread = threads.find(t => t.id === currentThreadId);
      if (!thread) { 
        showNotification("Error: No active session found"); 
        return; 
      }
      
      let content = `Enhanced Chain of Draft Studio - DeepSeek V3-0324\n`;
      content += `Model: ${CONFIG.currentModel}\n`;
      content += `Reasoning: ${CONFIG.reasoningMethod.toUpperCase()}\n`;
      content += `Word Limit: ${CONFIG.codWordLimit} words per step\n`;
      content += `Verification Depth: ${CONFIG.reflectionSettings.verificationDepth}\n`;
      content += `Adaptive: ${CONFIG.reasoningEnhancement === 'adaptive' ? 'Enabled' : 'Disabled'}\n`;
      content += `Export Date: ${new Date().toLocaleString()}\n\n`;
      content += `${'='.repeat(60)}\n\n`;
      
      thread.messages.forEach(msg => {
        if (msg.isPlaceholder) return;
        const prefix = msg.sender.toUpperCase();
        content += `${prefix}:\n${msg.content}\n\n`;
        
        if (msg.sender === 'bot' && !msg.isPlaceholder && !msg.isStreaming) {
          if (msg.stageInfo) {
            content += `[${msg.stageInfo}]\n`;
          }
          if (msg.reasoning) {
            content += `[Adaptive Reasoning: ${msg.reasoning}]\n`;
          }
          if (msg.wordCount !== undefined) {
            content += `[Words: ${msg.wordCount}]\n`;
          }
          if (msg.totalTokens !== undefined) {
            content += `[Tokens: ${msg.totalTokens}]\n`;
          }
          if (msg.durationSeconds !== undefined) {
            content += `[Stage Time: ${msg.durationSeconds}s]\n`;
          }
          if (msg.totalProcessingTime !== undefined) {
            content += `[Total Time: ${msg.totalProcessingTime}s]\n`;
          }
          content += "\n";
        }
      });
      
      const blob = new Blob([content], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${thread.name}_Enhanced_CoD_DeepSeek.txt`;
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => { 
        document.body.removeChild(a); 
        URL.revokeObjectURL(url); 
      }, 100);
      showNotification("Enhanced research export downloaded");
    }

    /***********************
     * App Initialization
     ***********************/
    function loadPersistedSettings() {
      try {
        const savedConfig = localStorage.getItem("enhancedCodConfig");
        if (savedConfig) {
          const parsed = JSON.parse(savedConfig);
          Object.assign(CONFIG, parsed);
        }
      } catch (error) {
        console.warn("Failed to load saved settings:", error);
      }
      
      // Load memory
      loadEnhancedMemoryFromStorage();
    }
    
    function initApp() { 
      loadPersistedSettings(); 
      createNewThread(); 
      initEventListeners(); 
      initMobileNavigation(); 
    }
    
    function initEventListeners() {
      const addListener = (id, event, handler) => { 
        const element = document.getElementById(id); 
        if (element) {
          element.addEventListener(event, handler); 
        } else {
          console.warn(`Element "${id}" not found`); 
        }
      };
      
      addListener("openSettings", "click", openSettingsModal); 
      addListener("closeSettings", "click", closeSettingsModal); 
      addListener("closeModalX", "click", closeSettingsModal); 
      addListener("saveSettings", "click", saveSettings);
      
      addListener("newThreadBtn", "click", createNewThread); 
      addListener("downloadTxtBtn", "click", downloadCurrentThreadAsTxt);
      
      addListener("clearThreadBtn", "click", () => { 
        if (confirm("Clear all messages in this session?")) { 
          const thread = threads.find(t => t.id === currentThreadId); 
          if (thread) { 
            thread.messages = []; 
            renderCurrentThreadMessages(); 
            showNotification("Session cleared"); 
          }
        }
      });

      addListener("deleteThreadBtn", "click", () => { 
        if (confirm("Are you sure you want to delete this session?")) { 
          threads = threads.filter(thread => thread.id !== currentThreadId);
          if (threads.length > 0) {
            currentThreadId = threads[0].id;
          } else {
            createNewThread(); 
            return;
          }
          updateThreadList();
          renderCurrentThreadMessages();
          showNotification("Session deleted");
        }
      });
      
      const textarea = document.getElementById('userInput');
      if (textarea) { 
        textarea.addEventListener('input', () => { 
          textarea.style.height = 'auto'; 
          textarea.style.height = (textarea.scrollHeight) + 'px'; 
        }); 
        
        textarea.addEventListener('keydown', (e) => { 
          if (e.key === 'Enter' && !e.shiftKey) { 
            e.preventDefault(); 
            document.getElementById('sendBtn')?.click(); 
          }
        });
      }
      
      addListener("sendBtn", "click", () => { 
        const textarea = document.getElementById('userInput'); 
        if (textarea) { 
          const message = textarea.value.trim(); 
          if (message || attachedFiles.length > 0 || attachedImages.length > 0) { 
            sendMessage(message); 
            textarea.value = ''; 
            textarea.style.height = 'auto'; 
          }
        }
      });
      
      handleFileInput();
      handleImageInput();
      
      window.addEventListener("click", (event) => { 
        const settingsModal = document.getElementById("settingsModal"); 
        if (settingsModal && event.target === settingsModal) {
          closeSettingsModal(); 
        }
      });
      
      setTimeout(() => { 
        setupTabNavigation(); 
        setupSliders(); 
      }, 100);
    }
    
    document.addEventListener("DOMContentLoaded", async function() {
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.documentElement.classList.add('dark');
      }
      
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => { 
        if (event.matches) {
          document.documentElement.classList.add('dark'); 
        } else {
          document.documentElement.classList.remove('dark'); 
        }
      });
      
      initApp();
    });
  </script>
</body>
</html>
<script async data-explicit-opt-in="true" data-cookie-opt-in="true" data-deployment-id="dpl_GW1Jh2wDtgrkSovmQxw6vrzWkxYs" src="https://vercel.live/_next-live/feedback/feedback.js"></script>
